<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台南環保局非法棄置智慧圍籬系統 - 車牌辨識管理 (實測圖檔整合)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- 核心風格 (一致性維持) --- */
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .header-section { background-color: #2c3e50; color: white; padding: 20px 0; margin-bottom: 20px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        
        /* 縮圖樣式 - 優化版 */
        .img-thumbnail-custom {
            width: 100px;
            height: 60px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #dee2e6;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.75rem;
            transition: transform 0.2s, border-color 0.2s;
            overflow: hidden;
            position: relative;
        }
        /* 確保圖片填滿且保持比例 */
        .img-thumbnail-custom img { width: 100%; height: 100%; object-fit: cover; }
        .img-thumbnail-custom:hover { border-color: #0d6efd; transform: scale(1.05); }

        /* 標籤樣式 */
        .nav-tabs .nav-link { color: #495057; font-weight: bold; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-top: 3px solid #0d6efd; }
        
        /* 狀態標籤 */
        .badge-recog-success { background-color: #198754; }
        .badge-recog-fail { background-color: #dc3545; }
        .badge-recog-manual { background-color: #fd7e14; }
    </style>
</head>
<body>

<div class="header-section">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="m-0"><i class="fas fa-car-side me-2"></i>台南環保局非法棄置智慧圍籬系統</h2>
                <p class="m-0 text-white-50">車牌辨識紀錄查詢與人工校正作業</p>
            </div>
            <div class="text-end">
                <span class="badge bg-warning text-dark"><i class="fas fa-image me-1"></i>KER-5379 實測影像整合版</span>
            </div>
        </div>
    </div>
</div>

<div class="container mb-5">

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="query-tab" data-bs-toggle="tab" data-bs-target="#query-content" type="button">
                <i class="fas fa-search me-1"></i> 辨識資料查詢
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="adjust-tab" data-bs-toggle="tab" data-bs-target="#adjust-content" type="button">
                <i class="fas fa-wrench me-1"></i> 無法辨識案件調整
                <span class="badge bg-danger rounded-pill ms-1" id="unrecognizedCount">0</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="query-content">
            <div class="card p-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">拍攝時間區間</label>
                        <div class="input-group">
                            <input type="date" class="form-control" id="qDateStart">
                            <span class="input-group-text">~</span>
                            <input type="date" class="form-control" id="qDateEnd">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">地點名稱</label>
                        <select class="form-select" id="qLocation">
                            <option value="">所有地點</option>
                            <option value="官田區">官田區國道三號烏山頭交流道</option>
                            <option value="白河區">白河區國道三號白河交流道</option>
                            <option value="柳營區">柳營區國道三號柳營交流道</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">啟用狀態</label>
                        <select class="form-select" id="qStatus">
                            <option value="">全部</option>
                            <option value="1">有效案件</option>
                            <option value="0">已註銷/無效</option>
                        </select>
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-primary" onclick="renderQueryTable()"><i class="fas fa-search me-1"></i> 查詢</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 15%">辨識日期時間</th>
                                    <th style="width: 20%">地點名稱</th>
                                    <th style="width: 10%">辨識車牌</th>
                                    <th style="width: 12%">前車牌照片</th>
                                    <th style="width: 12%">後車牌照片</th>
                                    <th style="width: 12%">車身照片</th>
                                    <th style="width: 8%">狀態</th>
                                    <th style="width: 11%">操作</th>
                                </tr>
                            </thead>
                            <tbody id="queryTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white small text-muted">
                    <i class="fas fa-info-circle me-1"></i> 請確認 <strong>前截圖.jpg</strong> 與 <strong>後截圖.jpg</strong> 已存放於此網頁相同目錄下，以正常顯示影像。
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="adjust-content">
             <div class="card p-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">發生時間</label>
                        <input type="date" class="form-control" id="aDate">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">地點名稱</label>
                        <select class="form-select" id="aLocation">
                            <option value="">所有地點</option>
                            <option value="官田區">官田區國道三號烏山頭交流道</option>
                            <option value="白河區">白河區國道三號白河交流道</option>
                            <option value="柳營區">柳營區國道三號柳營交流道</option>
                        </select>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary" onclick="renderAdjustTable()"><i class="fas fa-filter me-1"></i> 篩選未辨識案件</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-warning bg-opacity-10 fw-bold text-dark border-bottom">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i> 待人工校正列表
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0 align-middle">
                            <thead class="table-light text-center">
                                <tr>
                                    <th width="15%">時間/地點</th>
                                    <th width="15%">前車牌照片</th>
                                    <th width="15%">後車牌照片</th>
                                    <th width="15%">車身照片</th>
                                    <th width="25%">人工校正結果 (輸入車號)</th>
                                    <th width="15%">功能</th>
                                </tr>
                            </thead>
                            <tbody id="adjustTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="imgModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">原始影像檢視</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center bg-dark p-0">
                <img src="" id="modalImg" class="img-fluid" style="max-height: 500px; width: 100%; object-fit: contain;">
            </div>
            <div class="modal-footer bg-light">
                <div class="me-auto text-muted small" id="modalMeta"></div>
                <a href="#" id="modalDownloadLink" class="btn btn-primary" download>
                    <i class="fas fa-download me-1"></i> 下載此圖
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 1. 產生模擬截圖 (SVG - 用於其他模擬資料)
    function createMockImage(text, subText, color) {
        const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="400" height="250" viewBox="0 0 400 250">
            <rect width="400" height="250" fill="#333"/>
            <rect x="20" y="20" width="360" height="210" fill="#e9ecef" rx="10"/>
            <text x="50%" y="45%" dominant-baseline="middle" text-anchor="middle" font-family="monospace" font-weight="bold" font-size="28" fill="${color}">${text}</text>
            <text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="16" fill="#6c757d">${subText}</text>
            <rect x="100" y="180" width="200" height="30" fill="white" stroke="black"/>
            <text x="200" y="200" dominant-baseline="middle" text-anchor="middle" font-family="monospace" font-weight="bold" font-size="20" fill="black">${text.split(' ')[0]}</text>
        </svg>`;
        return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }

    // 2. 資料庫 (整合真實圖片)
    let lprData = [
        { 
            id: 101, 
            time: "2023-11-27 10:05:00", 
            loc: "官田區國道三號烏山頭交流道", 
            plate: "KER-5379", 
            active: true, 
            status: 1,
            // 【關鍵修改】這裡直接引用您的圖檔名稱
            frontImg: "前截圖.jpg",
            rearImg: "後截圖.jpg",
            fullImg: "車身照片.jpg" // 車身照片暫時使用前車影像替代
        },
        { 
            id: 102, 
            time: "2023-11-27 09:15:10", 
            loc: "白河區國道三號白河交流道", 
            plate: "XYZ-5678", 
            active: true, 
            status: 1,
            frontImg: createMockImage("XYZ-5678", "前車影像", "#333"),
            rearImg: createMockImage("XYZ-5678", "後車影像", "#333"),
            fullImg: createMockImage("XYZ-5678", "車身全景", "#333")
        },
        { 
            id: 103, 
            time: "2023-11-27 10:20:00", 
            loc: "柳營區國道三號柳營交流道", 
            plate: "無法辨識", 
            active: true, 
            status: 0, // 0 = 辨識失敗
            frontImg: createMockImage("無法辨識", "影像模糊/過曝", "#dc3545"),
            rearImg: createMockImage("無法辨識", "無後車牌", "#dc3545"),
            fullImg: createMockImage("UNKNOWN", "車身全景", "#dc3545")
        }
    ];

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('qDateStart').value = today;
        document.getElementById('qDateEnd').value = today;
        document.getElementById('aDate').value = today;

        renderQueryTable();
        renderAdjustTable();
        updateCount();
    });

    // 更新 Badge
    function updateCount() {
        const count = lprData.filter(d => d.status === 0).length;
        document.getElementById('unrecognizedCount').innerText = count;
    }

    // 3. 渲染查詢表格
    function renderQueryTable() {
        const tbody = document.getElementById('queryTableBody');
        tbody.innerHTML = '';
        
        const locFilter = document.getElementById('qLocation').value;
        const statusFilter = document.getElementById('qStatus').value;

        const filtered = lprData.filter(item => {
            const matchLoc = locFilter ? item.loc.includes(locFilter) : true;
            const matchStatus = statusFilter ? (statusFilter === '1' ? item.active : !item.active) : true; 
            return matchLoc && matchStatus;
        });

        filtered.forEach(item => {
            let plateBadge = item.plate === "無法辨識" 
                ? `<span class="badge badge-recog-fail">無法辨識</span>` 
                : `<span class="badge badge-recog-success">${item.plate}</span>`;
            
            if(item.plate === "KER-5379") {
                plateBadge += `<span class="badge bg-warning text-dark ms-1">重點車輛</span>`;
            }

            // 加入 onerror 處理，若找不到圖片則顯示替代文字
            const imgError = `onerror="this.parentNode.innerHTML='<span class=\\'text-danger small\\'>找不到圖檔<br>請確認路徑</span>'"`;

            const row = `
                <tr>
                    <td class="font-monospace small">${item.time}</td>
                    <td>${item.loc}</td>
                    <td class="font-monospace fs-6">${plateBadge}</td>
                    <td>
                        <div class="img-thumbnail-custom" onclick="openImgModal('${item.frontImg}', '${item.plate} - 前車牌', '${item.time}')">
                            <img src="${item.frontImg}" ${imgError}>
                        </div>
                    </td>
                    <td>
                        <div class="img-thumbnail-custom" onclick="openImgModal('${item.rearImg}', '${item.plate} - 後車牌', '${item.time}')">
                            <img src="${item.rearImg}" ${imgError}>
                        </div>
                    </td>
                    <td>
                        <div class="img-thumbnail-custom" onclick="openImgModal('${item.fullImg}', '${item.plate} - 車身', '${item.time}')">
                            <img src="${item.fullImg}" ${imgError}>
                        </div>
                    </td>
                    <td>${item.active ? '<span class="text-success small"><i class="fas fa-check"></i> 啟用</span>' : '<span class="text-secondary small">停用</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="alert('下載 ${item.plate} 相關影像包...')">
                            <i class="fas fa-download"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // 4. 渲染調整表格
    function renderAdjustTable() {
        const tbody = document.getElementById('adjustTableBody');
        tbody.innerHTML = '';
        
        const locFilter = document.getElementById('aLocation').value;
        const filtered = lprData.filter(item => {
            const matchLoc = locFilter ? item.loc.includes(locFilter) : true;
            return item.status === 0 && matchLoc;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">目前無待處理的無法辨識案件</td></tr>';
            return;
        }

        filtered.forEach(item => {
            const imgError = `onerror="this.parentNode.innerHTML='<span class=\\'text-danger small\\'>圖檔遺失</span>'"`;
            
            const row = `
                <tr id="row-${item.id}">
                    <td class="small text-start">
                        <div class="fw-bold">${item.time}</div>
                        <div class="text-muted">${item.loc}</div>
                    </td>
                    <td><div class="img-thumbnail-custom mx-auto" style="width:120px; height:80px;" onclick="openImgModal('${item.frontImg}', '待校正 - 前', '${item.time}')"><img src="${item.frontImg}" ${imgError}></div></td>
                    <td><div class="img-thumbnail-custom mx-auto" style="width:120px; height:80px;" onclick="openImgModal('${item.rearImg}', '待校正 - 後', '${item.time}')"><img src="${item.rearImg}" ${imgError}></div></td>
                    <td><div class="img-thumbnail-custom mx-auto" style="width:120px; height:80px;" onclick="openImgModal('${item.fullImg}', '待校正 - 車身', '${item.time}')"><img src="${item.fullImg}" ${imgError}></div></td>
                    <td>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-keyboard"></i></span>
                            <input type="text" class="form-control font-monospace fw-bold" id="input-${item.id}" placeholder="請輸入正確車號..." style="text-transform: uppercase;">
                        </div>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-success w-100" onclick="submitCorrection(${item.id})">
                            <i class="fas fa-check me-1"></i> 送出
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // 5. 送出校正
    function submitCorrection(id) {
        const input = document.getElementById(`input-${id}`);
        const newVal = input.value.trim().toUpperCase();
        if (!newVal) { alert("請輸入車牌號碼！"); return; }

        if(!confirm(`確認將此案件修正為車號 [ ${newVal} ] 並上傳？`)) return;

        const item = lprData.find(d => d.id === id);
        item.plate = newVal;
        item.status = 1;
        
        // 更新圖片文字 (模擬SVG變更，若為實體圖檔通常不變或由後端處理)
        item.frontImg = createMockImage(newVal, "前車影像 (校正後)", "#198754");
        item.rearImg = createMockImage(newVal, "後車影像 (校正後)", "#198754");

        alert(`修正成功！車號 [${newVal}] 已上傳。`);
        renderAdjustTable();
        renderQueryTable();
        updateCount();
    }

    // 6. 開啟圖片 Modal
    function openImgModal(src, title, time) {
        document.getElementById('modalImg').src = src;
        document.querySelector('.modal-title').innerText = title;
        document.getElementById('modalMeta').innerHTML = `<i class="fas fa-clock"></i> 拍攝時間: ${time}`;
        
        const dlLink = document.getElementById('modalDownloadLink');
        dlLink.href = src;
        
        const myModal = new bootstrap.Modal(document.getElementById('imgModal'));
        myModal.show();
    }
</script>

</body>
</html>